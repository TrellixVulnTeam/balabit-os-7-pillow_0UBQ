Backport of:

From 8531b01d6cdf0b70f256f93092caa2a5d91afc11 Mon Sep 17 00:00:00 2001
From: Andrew Murray <radarhere@users.noreply.github.com>
Date: Sun, 2 Jan 2022 17:23:49 +1100
Subject: [PATCH] Restrict builtins for ImageMath.eval

---
 Tests/test_imagemath.py     | 7 +++++++
 docs/releasenotes/9.0.0.rst | 8 ++++++++
 src/PIL/ImageMath.py        | 7 ++++++-
 3 files changed, 21 insertions(+), 1 deletion(-)

--- a/Tests/test_imagemath.py
+++ b/Tests/test_imagemath.py
@@ -1,6 +1,8 @@
 from __future__ import print_function
 from helper import unittest, PillowTestCase
 
+import pytest
+
 from PIL import Image
 from PIL import ImageMath
 
@@ -58,6 +60,10 @@ class TestImageMath(PillowTestCase):
         self.assertEqual(pixel(
             ImageMath.eval("float(B)**33", images)), "F 8589934592.0")
 
+    def test_prevent_exec():
+        with pytest.raises(ValueError):
+            ImageMath.eval("exec('pass')")
+
     def test_logical(self):
         self.assertEqual(pixel(ImageMath.eval("not A", images)), 0)
         self.assertEqual(pixel(ImageMath.eval("A and B", images)), "L 2")
--- a/src/PIL/ImageMath.py
+++ b/src/PIL/ImageMath.py
@@ -263,7 +263,12 @@ def eval(expression, _dict={}, **kw):
         if hasattr(v, "im"):
             args[k] = _Operand(v)
 
-    out = builtins.eval(expression, args)
+    code = compile(expression, "<string>", "eval")
+    for name in code.co_names:
+        if name not in args and name != "abs":
+            raise ValueError("'%s' not allowed" % name)
+
+    out = builtins.eval(expression, {"__builtins": {"abs": abs}}, args)
     try:
         return out.im
     except AttributeError:
